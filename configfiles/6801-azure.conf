# SOF-ELKÂ® Configuration File
# (C)2021 Lewes Technology Consulting, LLC
#
# This file parses CSV-formatted Azure logs

filter {
  if [type] == "azure" {

    if "csv" in [tags] {
      ### Azure Activity Logs, in CSV format
      # See https://docs.microsoft.com/en-us/azure/azure-monitor/platform/activity-log-schema
      csv {
        separator => ","
        skip_empty_rows => "true"
        columns => [ "correlation_guid", "operation_name", "status", "event_category", "level", "datetime", "subscription_guid", "initiator", "resource_type", "resource_group", "resource" ]
        remove_field => "message"
        add_tag => [ "azure_csv_activity_log" ]
      }

      if [datetime] == "Time" {
        drop {}  # drop the first line that contains the column names.
      }

      date {
        match => [ "datetime", "ISO8601" ]
      }

      # remove unneccesary fields
      mutate {
        remove_field => [ "datetime" ]
      }
    }

    ### Azure SignIn Logs, in JSON format
    # https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/reference-azure-monitor-sign-ins-log-schema
    if [raw][category] == "SignInLogs" or [raw][category] == "ManagedIdentitySignInLogs" or [raw][category] == "NonInteractiveUserSignInLogs" {
      date {
        match => [ "[raw][time]", "ISO8601" ]
      }

      mutate {
        rename => {
          "[raw][category]" => "category"
          "[raw][tenantId]" => "tenant_guid"
          "[raw][resultType]" => "result_type"
          "[raw][resultSignature]" => "result_signature"
          "[raw][resultDescription]" => "result_description"
          "[raw][callerIpAddress]" => "source_ip"
          "[raw][correlationID]" => "correlation_guid"
          "[raw][location]" => "datacenter_location"
          "[raw][properties][userDisplayName]" => "user_name"
          "[raw][properties][userPrincipalName]" => "user_principal_name"
          "[raw][properties][userId]" => "user_id"
          "[raw][properties][appId]" => "application_id"
          "[raw][properties][appDisplayName]" => "application_name"
          "[raw][properties][status][errorCode]" => "error_code"
          "[raw][properties][failureReason]" => "failure_reason"
          "[raw][properties][clientAppUsed]" => "client_app_used"
          "[raw][properties][userAgent]" => "useragent"
          "[raw][properties][authenticationDetails]" => "authentication_details"
        }
      }

      # remove remaining fields
      mutate {
        remove_field => [ "raw" ]
      }

    }

    ### Azure Audit Logs, in JSON format
    # https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/reference-azure-monitor-audit-log-schema
    if [raw][category] == "AuditLogs" or [raw][category] == "Audit" {
      date {
        match => [ "[raw][time]", "ISO8601" ]
      }

      mutate {
        rename => {
          "[raw][category]" => "category"
          "[raw][tenantId]" => "tenant_guid"
          "[raw][resourceId]" => "resource_id"
          "[raw][operationName]" => "operation_name"
          "[raw][resultSignature]" => "result_signature"
          "[raw][resultDescription]" => "result_description"
          "[raw][callerIpAddress]" => "source_ip"
          "[raw][correlationID]" => "correlation_guid"
          "[raw][location]" => "datacenter_location"
          "[raw][identity]" => "identity"
          "[raw][level]" => "level"
          "[raw][properties][id]" => "property_id"
          "[raw][properties][category]" => "property_category"
          "[raw][properties][result]" => "result"
          "[raw][properties][result_reason]" => "result_reason"
          "[raw][properties][activityDisplayName]" => "activity_display_name"
          "[raw][properties][loggedByService]" => "logged_by_service"
          "[raw][properties][operationType]" => "operation_type"
          "[raw][properties][initiatedBy][user][displayName]" => "initiating_user_display_name"
          "[raw][properties][initiatedBy][user][userPrincipalName]" => "initiating_user_principal_name"
          "[raw][properties][initiatedBy][user][ipAddress]" => "initiating_user_ip"
        }
      }

      # remove remaining fields
      mutate {
        remove_field => [ "raw" ]
      }
    }

    ### Azure Activity Logs, in JSON format
    # https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/reference-azure-monitor-audit-log-schema
    if [raw][category] == "Administrative" {
      date {
        match => [ "[raw][time]", "ISO8601" ]
      }

      mutate {
        rename => {
          "[raw][category]" => "category"
          "[raw][resourceId]" => "resource_id"
          "[raw][RoleLocation]" => "role_location"
          "[raw][operationName]" => "operation_name"
          "[raw][resultType]" => "result_type"
          "[raw][resultSignature]" => "result_signature"
          "[raw][callerIpAddress]" => "source_ip"
          "[raw][correlationId]" => "correlation_guid"
          "[raw][identity][authorization][scope]" => "scope"
          "[raw][identity][authorization][action]" => "action"
          "[raw][identity][authorization][evidence][role]" => "role"
        }
      }

      # remove remaining fields
      mutate {
        remove_field => [ "raw" ]
      }
    }

    # drop the rest - any unhandled [raw][category] value results in a current time stamp on the unparsed recorc
    if [raw][category] {
      drop {}
    }

  }
}